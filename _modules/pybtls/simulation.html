
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pybtls.simulation &#8212; PyBTLS 0.3.8 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=c1cae59a"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/pybtls/simulation';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.3.8" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/PyBTLS_logo_small.png" class="logo__image only-light" alt="PyBTLS 0.3.8 documentation - Home"/>
    <img src="../../_static/PyBTLS_logo_small.png" class="logo__image only-dark pst-js-only" alt="PyBTLS 0.3.8 documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../install.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorial.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../theory.html">
    Theoretical Background
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../references.html">
    References
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../developer.html">
    Instructions for Developers
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ccaprani/btls" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/ccaprani" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-twitter-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../install.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorial.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../theory.html">
    Theoretical Background
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../references.html">
    References
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer.html">
    Instructions for Developers
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ccaprani/btls" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/ccaprani" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-twitter-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">pybtls.simulation</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for pybtls.simulation</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The module that assembles everything together for the simulation. \n</span>
<span class="sd">The methods and classes that are not defined in Python are defined in C++ py_main.cpp.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">.lib.BTLS</span> <span class="kn">import</span> <span class="n">Vehicle</span><span class="p">,</span> <span class="n">_Vehicle</span><span class="p">,</span> <span class="n">_VehClassPattern</span><span class="p">,</span> <span class="n">_VehClassAxle</span><span class="p">,</span> <span class="n">_VehicleBuffer</span>
<span class="kn">from</span> <span class="nn">.bridge</span> <span class="kn">import</span> <span class="n">Bridge</span>
<span class="kn">from</span> <span class="nn">.traffic</span> <span class="kn">import</span> <span class="n">TrafficGenerator</span><span class="p">,</span> <span class="n">TrafficLoader</span>
<span class="kn">from</span> <span class="nn">.output</span> <span class="kn">import</span> <span class="n">OutputConfig</span><span class="p">,</span> <span class="n">_OutputManager</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">importlib.metadata</span> <span class="k">as</span> <span class="nn">package_metadata</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">platform</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Simulation&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="Simulation">
<a class="viewcode-back" href="../../gen/pybtls.simulation.Simulation.html#pybtls.simulation.Simulation">[docs]</a>
<span class="k">class</span> <span class="nc">Simulation</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./&quot;</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the class for setting and running simulations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_dir : Path, optional\n</span>
<span class="sd">            The output directory for the simulation results. The default is &quot;./&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">multiprocessing</span><span class="o">.</span><span class="n">set_start_method</span><span class="p">(</span><span class="s2">&quot;spawn&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sim_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sim_argument</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sim_output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_root</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_version_info</span><span class="p">()</span>

<div class="viewcode-block" id="Simulation.add_sim">
<a class="viewcode-back" href="../../gen/pybtls.simulation.Simulation.html#pybtls.simulation.Simulation.add_sim">[docs]</a>
    <span class="k">def</span> <span class="nf">add_sim</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bridge</span><span class="p">:</span> <span class="n">Bridge</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">traffic</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">TrafficGenerator</span><span class="p">,</span> <span class="n">TrafficLoader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">no_day</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_config</span><span class="p">:</span> <span class="n">OutputConfig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">time_step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">min_gvw</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">vehicle</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Vehicle</span><span class="p">,</span> <span class="n">_Vehicle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">active_lane</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a simulation to the simulation queue.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bridge : Bridge, optional\n</span>
<span class="sd">            The bridge to be calculated load effect. If not provided, there will not be load effect calculation.</span>

<span class="sd">        traffic : Union[TrafficGenerator,TrafficLoader], optional\n</span>
<span class="sd">            The traffic can be either generated or recorded.</span>

<span class="sd">        no_day : int, optional\n</span>
<span class="sd">            The number of days to be simulated (in day). If not provided, the number of days will be the same as the recorded traffic (if given). A single-vehicle simulation will ignore this argument.</span>

<span class="sd">        output_config : OutputConfig, optional\n</span>
<span class="sd">            The output configuration. This argument is essential for traffic simulation. A single-vehicle simulation will ignore this argument.</span>

<span class="sd">        time_step : float, optional\n</span>
<span class="sd">            The calculation time step (in s) for the simulation (about precision). This argument is only used in load effect calculation for traffic simulation. A single-vehicle simulation will ignore this argument.</span>

<span class="sd">        min_gvw : int, optional\n</span>
<span class="sd">            The minimum gross vehicle weight (in kN) to be considered in the load effect calculation for traffic simulation. A single-vehicle simulation will ignore this argument.</span>

<span class="sd">        vehicle : Union[Vehicle, _Vehicle], optional\n</span>
<span class="sd">            The vehicle for a single-vehicle simulation.</span>

<span class="sd">        active_lane : list[int], optional\n</span>
<span class="sd">            The active bridge lanes during the simulation. The default is None, which means all lanes are active. [1-based global index].</span>

<span class="sd">        tag : str, optional\n</span>
<span class="sd">            The tag for the simulation. The default tag will be &quot;Sim_{Simulation Order}&quot;.</span>

<span class="sd">        Keyword Arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        overlap_avoid_distance : float, optional\n</span>
<span class="sd">            The minimum chase distance (in m) between two vehicles to avoid overlap (should equal to bridge length). If the bridge argument has an input then no need to specify this argument. The default is 100.0.</span>

<span class="sd">        track_progress : bool, optional\n</span>
<span class="sd">            Whether to track the simulation progress. A single-vehicle simulation will ignore this argument. The default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sim_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sim_tag</span> <span class="o">=</span> <span class="s2">&quot;Sim_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sim_count</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sim_tag</span> <span class="o">=</span> <span class="n">tag</span>

        <span class="n">overlap_avoid_distance</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_chase_distance&quot;</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">)</span>
        <span class="n">track_progress</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;track_progress&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sim_argument</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">bridge</span><span class="p">,</span>
                <span class="n">traffic</span><span class="p">,</span>
                <span class="n">no_day</span><span class="p">,</span>
                <span class="n">output_config</span><span class="p">,</span>
                <span class="n">time_step</span><span class="p">,</span>
                <span class="n">min_gvw</span><span class="p">,</span>
                <span class="n">vehicle</span><span class="p">,</span>
                <span class="n">active_lane</span><span class="p">,</span>
                <span class="n">sim_tag</span><span class="p">,</span>
                <span class="n">overlap_avoid_distance</span><span class="p">,</span>
                <span class="n">track_progress</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_output_root</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Simulation.run">
<a class="viewcode-back" href="../../gen/pybtls.simulation.Simulation.html#pybtls.simulation.Simulation.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_core</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the simulations. \n</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        no_core : int, optional\n</span>
<span class="sd">            The number of cores to be used for multi-core running. \n</span>
<span class="sd">            If no_core is one or there is only one added simulation, the running will be single-core. \n</span>
<span class="sd">            Otherwise, the running will be multi-core. \n</span>
<span class="sd">            By default, (no_cpu_logic_core - 2) processes will be used for multi-core running.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">no_core</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sim_argument</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sim_arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_argument</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sim_output</span><span class="p">[</span><span class="n">sim_arg</span><span class="p">[</span><span class="mi">8</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_sim</span><span class="p">(</span><span class="n">sim_arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">no_processes</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">no_core</span> <span class="k">if</span> <span class="n">no_core</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">no_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_single_sim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_argument</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sim_arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sim_argument</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sim_output</span><span class="p">[</span><span class="n">sim_arg</span><span class="p">[</span><span class="mi">8</span><span class="p">]]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>


<div class="viewcode-block" id="Simulation.get_output">
<a class="viewcode-back" href="../../gen/pybtls.simulation.Simulation.html#pybtls.simulation.Simulation.get_output">[docs]</a>
    <span class="k">def</span> <span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_OutputManager</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the output manager for each simulation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict[str, _OutputManager]</span>
<span class="sd">            A dict storing output manager for each simulation.\n</span>
<span class="sd">            The keys are the sim_tags.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_output</span></div>


<div class="viewcode-block" id="Simulation.get_no_sim">
<a class="viewcode-back" href="../../gen/pybtls.simulation.Simulation.html#pybtls.simulation.Simulation.get_no_sim">[docs]</a>
    <span class="k">def</span> <span class="nf">get_no_sim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the number of simulations.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The number of simulations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_count</span></div>


    <span class="k">def</span> <span class="nf">_single_sim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_OutputManager</span><span class="p">:</span>
        <span class="p">(</span>
            <span class="n">bridge</span><span class="p">,</span>
            <span class="n">traffic</span><span class="p">,</span>
            <span class="n">no_day</span><span class="p">,</span>
            <span class="n">output_config</span><span class="p">,</span>
            <span class="n">time_step</span><span class="p">,</span>
            <span class="n">min_gvw</span><span class="p">,</span>
            <span class="n">vehicle</span><span class="p">,</span>
            <span class="n">active_lane</span><span class="p">,</span>
            <span class="n">sim_tag</span><span class="p">,</span>
            <span class="n">overlap_avoid_distance</span><span class="p">,</span>
            <span class="n">track_progress</span><span class="p">,</span>
            <span class="n">output_root</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">args</span>

        <span class="k">if</span> <span class="n">traffic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_traffic_sim</span><span class="p">(</span>
                <span class="n">bridge</span><span class="p">,</span>
                <span class="n">traffic</span><span class="p">,</span>
                <span class="n">no_day</span><span class="p">,</span>
                <span class="n">output_config</span><span class="p">,</span>
                <span class="n">time_step</span><span class="p">,</span>
                <span class="n">min_gvw</span><span class="p">,</span>
                <span class="n">active_lane</span><span class="p">,</span>
                <span class="n">sim_tag</span><span class="p">,</span>
                <span class="n">overlap_avoid_distance</span><span class="p">,</span>
                <span class="n">track_progress</span><span class="p">,</span>
                <span class="n">output_root</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">vehicle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_vehicle_sim</span><span class="p">(</span>
                <span class="n">bridge</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">,</span> <span class="n">active_lane</span><span class="p">,</span> <span class="n">sim_tag</span><span class="p">,</span> <span class="n">output_root</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either traffic or vehicle should be provided.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_single_vehicle_sim</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">bridge</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">,</span> <span class="n">active_lane</span><span class="p">,</span> <span class="n">sim_tag</span><span class="p">,</span> <span class="n">output_root</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_OutputManager</span><span class="p">:</span>
        <span class="n">sim_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_root</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">sim_tag</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">output_root</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">sim_tag</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">Bridge</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Argument bridge needs to be Bridge type.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="p">(</span><span class="n">Vehicle</span><span class="p">,</span> <span class="n">_Vehicle</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Argument vehicle needs to be Vehicle type.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">active_lane</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lane_for_calc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bridge</span><span class="o">.</span><span class="n">no_lane</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># 1-based global index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">active_lane</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Argument active_lane needs to be a list.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">active_lane</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bridge</span><span class="o">.</span><span class="n">no_lane</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The maximum lane index in active_lane is larger than the number of lanes on the bridge.&quot;</span>
                <span class="p">)</span>
            <span class="n">lane_for_calc</span> <span class="o">=</span> <span class="n">active_lane</span>  <span class="c1"># 1-based global index</span>

        <span class="n">no_dir</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">bridge_length</span> <span class="o">=</span> <span class="n">bridge</span><span class="o">.</span><span class="n">length</span>
        <span class="n">vehicle_time_gap</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">bridge_length</span> <span class="o">+</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">get_length</span><span class="p">())</span> <span class="o">/</span> <span class="mf">1.0</span>  <span class="c1"># in s</span>

        <span class="n">vehicle</span><span class="o">.</span><span class="n">set_velocity</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># 1 m/s</span>

        <span class="n">no_lane_dir_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">bridge</span><span class="o">.</span><span class="n">no_lane</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">no_lane_dir_2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">bridge</span><span class="o">.</span><span class="n">no_lane</span><span class="p">]</span>

        <span class="n">output_config</span> <span class="o">=</span> <span class="n">OutputConfig</span><span class="p">()</span>
        <span class="n">output_config</span><span class="o">.</span><span class="n">set_event_output</span><span class="p">(</span>
            <span class="n">write_time_history</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">write_each_event</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>  <span class="c1"># set output</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_dir</span><span class="p">):</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">vehicle</span><span class="o">.</span><span class="n">set_time</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;dir&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;dir&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">output_config</span><span class="o">.</span><span class="n">_setRoad</span><span class="p">(</span>
                <span class="n">bridge</span><span class="o">.</span><span class="n">no_lane</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">no_lane_dir_1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">no_lane_dir_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">load_calc</span> <span class="o">=</span> <span class="n">bridge</span><span class="o">.</span><span class="n">_get_bridge</span><span class="p">(</span>
                <span class="n">output_config</span>
            <span class="p">)</span>  <span class="c1"># vehicle drive from one dirn then another</span>

            <span class="n">load_calc</span><span class="o">.</span><span class="n">initializeDataMgr</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span>
            <span class="n">load_calc</span><span class="o">.</span><span class="n">setCalcTimeStep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">lane_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lane_for_calc</span><span class="p">):</span>
                <span class="n">next_arrival_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">vehicle_time_gap</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">set_time</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span>

                <span class="n">vehicle</span><span class="o">.</span><span class="n">set_direction</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">vehicle</span><span class="o">.</span><span class="n">set_local_from_global_lane</span><span class="p">(</span><span class="n">lane_index</span><span class="p">,</span> <span class="n">bridge</span><span class="o">.</span><span class="n">no_lane</span><span class="p">)</span>
                <span class="n">load_calc</span><span class="o">.</span><span class="n">addVehicle</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>
                <span class="n">load_calc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">next_arrival_time</span><span class="p">,</span> <span class="n">current_time</span><span class="p">)</span>

                <span class="n">current_time</span> <span class="o">=</span> <span class="n">next_arrival_time</span>

            <span class="n">load_calc</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">sim_root</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_OutputManager</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="n">sim_tag</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_single_traffic_sim</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bridge</span><span class="p">,</span>
        <span class="n">traffic</span><span class="p">,</span>
        <span class="n">no_day</span><span class="p">,</span>
        <span class="n">output_config</span><span class="p">,</span>
        <span class="n">time_step</span><span class="p">,</span>
        <span class="n">min_gvw</span><span class="p">,</span>
        <span class="n">active_lane</span><span class="p">,</span>
        <span class="n">sim_tag</span><span class="p">,</span>
        <span class="n">overlap_avoid_distance</span><span class="p">,</span>
        <span class="n">track_progress</span><span class="p">,</span>
        <span class="n">output_root</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_OutputManager</span><span class="p">:</span>
        <span class="n">sim_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_root</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">sim_tag</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">output_root</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">sim_tag</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">traffic</span><span class="p">,</span> <span class="n">TrafficGenerator</span><span class="p">)</span> <span class="ow">and</span> <span class="n">no_day</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument no_day is not given.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">traffic</span><span class="p">,</span> <span class="n">TrafficLoader</span><span class="p">)</span> <span class="ow">and</span> <span class="n">no_day</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">no_day</span> <span class="o">=</span> <span class="n">traffic</span><span class="o">.</span><span class="n">sim_day</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">no_day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">no_day</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_config</span><span class="p">,</span> <span class="n">OutputConfig</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Argument output needs to be OutputConfig type.&quot;</span><span class="p">)</span>

        <span class="n">output_config</span><span class="o">.</span><span class="n">_setRoad</span><span class="p">(</span>
            <span class="n">traffic</span><span class="o">.</span><span class="n">no_lane</span><span class="p">,</span>
            <span class="n">traffic</span><span class="o">.</span><span class="n">no_dir</span><span class="p">,</span>
            <span class="n">traffic</span><span class="o">.</span><span class="n">no_lane_dir_1</span><span class="p">,</span>
            <span class="n">traffic</span><span class="o">.</span><span class="n">no_lane_dir_2</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># this info is used by VehBuffer and EventManager(in CBridge)</span>

        <span class="k">if</span> <span class="n">traffic</span><span class="o">.</span><span class="n">vehicle_classifier</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">vehicle_classifier</span> <span class="o">=</span> <span class="n">_VehClassAxle</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vehicle_classifier</span> <span class="o">=</span> <span class="n">_VehClassPattern</span><span class="p">()</span>

        <span class="n">current_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">no_day</span> <span class="o">*</span> <span class="mf">86400.0</span>  <span class="c1"># 24*3600</span>

        <span class="n">vehicle_buffer</span> <span class="o">=</span> <span class="n">_VehicleBuffer</span><span class="p">(</span><span class="n">output_config</span><span class="p">,</span> <span class="n">vehicle_classifier</span><span class="p">,</span> <span class="n">current_time</span><span class="p">)</span>
        <span class="n">bridge_length</span> <span class="o">=</span> <span class="n">overlap_avoid_distance</span>  <span class="c1"># magic number, to avoid vehicle overlap</span>

        <span class="k">if</span> <span class="n">track_progress</span><span class="p">:</span>
            <span class="n">current_day</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sim_progress_print</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting simulation...&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Day complete...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">Bridge</span><span class="p">):</span>
            <span class="n">load_calc</span> <span class="o">=</span> <span class="n">bridge</span><span class="o">.</span><span class="n">_get_bridge</span><span class="p">(</span><span class="n">output_config</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bridge</span><span class="o">.</span><span class="n">no_lane</span> <span class="o">!=</span> <span class="n">traffic</span><span class="o">.</span><span class="n">no_lane</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;The number of lanes in the bridge and traffic generator are not equal.&quot;</span>
                <span class="p">)</span>
            <span class="n">load_calc</span><span class="o">.</span><span class="n">initializeDataMgr</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span>
            <span class="n">load_calc</span><span class="o">.</span><span class="n">setCalcTimeStep</span><span class="p">(</span><span class="n">time_step</span><span class="p">)</span>
            <span class="n">bridge_length</span> <span class="o">=</span> <span class="n">bridge</span><span class="o">.</span><span class="n">length</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">traffic</span><span class="p">,</span> <span class="n">TrafficGenerator</span><span class="p">):</span>
            <span class="n">lane_list</span> <span class="o">=</span> <span class="n">traffic</span><span class="o">.</span><span class="n">_get_traffic_generator</span><span class="p">(</span><span class="n">bridge_length</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">traffic</span><span class="p">,</span> <span class="n">TrafficLoader</span><span class="p">):</span>
            <span class="n">lane_list</span> <span class="o">=</span> <span class="n">traffic</span><span class="o">.</span><span class="n">_get_traffic_loader</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;traffic should be either TrafficGenerator or TrafficLoader.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">active_lane</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lane_for_calc</span> <span class="o">=</span> <span class="n">lane_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">active_lane</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Argument active_lane needs to be a list.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">active_lane</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">traffic</span><span class="o">.</span><span class="n">no_lane</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The maximum lane index in active_lane is larger than the number of lanes on the bridge.&quot;</span>
                <span class="p">)</span>
            <span class="n">lane_for_calc</span> <span class="o">=</span> <span class="p">[</span><span class="n">lane_list</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">active_lane</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">current_time</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">:</span>
            <span class="n">lane_for_calc</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lane_for_calc</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">getNextArrivalTime</span><span class="p">())</span>

            <span class="n">next_arrival_time</span> <span class="o">=</span> <span class="n">lane_for_calc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getNextArrivalTime</span><span class="p">()</span>
            <span class="n">vehicle</span> <span class="o">=</span> <span class="n">lane_for_calc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getNextVehicle</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">vehicle</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">):</span>  <span class="c1"># This is to skip the empty (NoneType) vehicle at the end of Read&amp;Sim</span>
                <span class="k">break</span>

            <span class="n">vehicle_buffer</span><span class="o">.</span><span class="n">addVehicle</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">Bridge</span><span class="p">):</span>
                <span class="n">load_calc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">next_arrival_time</span><span class="p">,</span> <span class="n">current_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">get_gvw</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_gvw</span><span class="p">):</span>  <span class="c1"># BTLS requires in size_t kN</span>
                    <span class="n">load_calc</span><span class="o">.</span><span class="n">addVehicle</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>

            <span class="n">current_time</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">track_progress</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="mi">86400</span> <span class="o">*</span> <span class="p">(</span><span class="n">current_day</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">current_day</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">sim_progress_print</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_day</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_day</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">sim_progress_print</span><span class="p">)</span>
                        <span class="n">sim_progress_print</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">Bridge</span><span class="p">):</span>
            <span class="n">load_calc</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="n">vehicle_buffer</span><span class="o">.</span><span class="n">flushBuffer</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">sim_root</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_OutputManager</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="n">sim_tag</span><span class="p">,</span> <span class="n">output_config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_version_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method writes the Python and pybtls version information to the output directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">version_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_root</span> <span class="o">/</span> <span class="s2">&quot;sim_version_info.txt&quot;</span>

        <span class="n">pybtls_version</span> <span class="o">=</span> <span class="n">package_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;pybtls&quot;</span><span class="p">)</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span>
        <span class="n">cpu_architecture</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">machine</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">version_file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">version_file</span><span class="p">:</span>
            <span class="n">version_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyBTLS Version: </span><span class="si">{</span><span class="n">pybtls_version</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">version_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Python Version: </span><span class="si">{</span><span class="n">python_version</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">version_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CPU Architecture: </span><span class="si">{</span><span class="n">cpu_architecture</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, The PyBTLS Developers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>